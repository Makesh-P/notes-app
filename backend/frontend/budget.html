<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget</title>
<style>
/* YOUR EXACT CSS - NO CHANGES */
* { box-sizing:border-box; margin:0; padding:0; font-family:Segoe UI, sans-serif; }
body { background:#f5f5f5; min-height:100vh; padding:20px; }
.budget-page { max-width:900px; margin:auto; }
.page-title { font-size:22px; font-weight:600; margin-bottom:20px; }
.add-budget { display:flex; gap:10px; margin-bottom:20px; }
.add-budget input { flex:1; padding:12px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
.add-budget button { padding:12px 20px; font-size:16px; background:#000; color:#fff; border:none; border-radius:8px; cursor:pointer; }
.add-budget button:hover { background:#333 }
.budget-card { border-radius:14px; padding:18px; margin-bottom:18px; box-shadow:0 6px 20px rgba(0,0,0,.15); position:relative; }
.delete-budget { position:absolute; top:12px; right:14px; cursor:pointer; font-size:18px; font-weight:bold; }
.budget-title { font-size:18px; font-weight:600; margin-bottom:15px; border:none; background:transparent; outline:none; width:100%; }
.row { display:flex; gap:10px; margin-bottom:10px; }
.row input { padding:10px; border-radius:8px; border:1px solid #ccc; }
.item { flex:2 } .price,.qty { flex:1 }
.add-row-btn { padding:10px 18px; background:#000; color:#fff; border:none; border-radius:8px; cursor:pointer; }
.add-row-btn:hover { background:#333 }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { padding:8px; border-bottom:1px solid rgba(0,0,0,.1); }
td[contenteditable] { outline:none; }
.remove-row { cursor:pointer; font-weight:bold; }
.total { text-align:right; font-weight:600; margin-top:12px; }
.back-link { text-decoration:none; color:#666; font-weight:600; margin-bottom:20px; display:inline-block; font-size:14px; }
.back-link:hover { color:#000; }
@media(max-width:600px) { .row { flex-direction:column } }
</style>
</head>
<body>
<div class="budget-page">
  <a href="index.html" class="back-link">← Back to Home</a>
  <div class="page-title">Budgets</div>
  <div class="add-budget">
    <input id="budgetName" placeholder="New Budget Title">
    <button onclick="createBudget()">Add</button>
  </div>
  <div id="budgetContainer"></div>
</div>

<script>
const API = "https://notes-app-a631.onrender.com";
let budgets = [];
let budgetId = null;
let isSaving = false;

// ✅ FIXED #1: Load existing budget OR show empty
const params = new URLSearchParams(window.location.search);
budgetId = params.get("id");

if (budgetId) {
  // Load SINGLE budget (like todo/note)
  fetch(`${API}/budget/${budgetId}`)
    .then(res => res.json())
    .then(data => {
      if (data.title) {
        budgets = [{
          id: parseInt(budgetId),
          title: data.title,
          color: "#fff4e6",
          items: JSON.parse(data.data || "[]")
        }];
        render();
      }
    })
    .catch(err => console.error(err));
}

// ✅ FIXED #2: Central save function (Ctrl+S)
function saveData(silent = false) {
  if (isSaving || budgets.length === 0) return;
  
  isSaving = true;
  const currentBudget = budgets[0]; // Single budget mode
  
  fetch(`${API}/budget`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id: currentBudget.id || null,
      title: currentBudget.title,
      data: JSON.stringify(currentBudget.items),
      total: currentBudget.items.reduce((sum, item) => sum + (item.price * item.qty || 0), 0)
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok && data.id && !currentBudget.id) {
      currentBudget.id = data.id;
      history.replaceState(null, "", `budget.html?id=${data.id}`);
    }
    if (!silent) alert("Budget Saved ✔");
  })
  .catch(err => console.error("Save error:", err))
  .finally(() => { isSaving = false; });
}

// ✅ FIXED #3: Create new budget
function createBudget() {
  const title = document.getElementById("budgetName").value.trim();
  if (!title) return;
  
  budgets = [{
    title: title,
    color: "#fff4e6",
    items: []
  }];
  document.getElementById("budgetName").value = "";
  render();
  saveData(true); // Auto-save new budget
}

// ✅ FIXED #4: Delete THIS budget (red X)
function deleteBudget() {
  if (budgetId && confirm("Delete this budget?")) {
    fetch(`${API}/budget/${budgetId}`, { method: "DELETE" })
      .then(() => { window.location.href = "index.html"; })
      .catch(err => console.error(err));
  }
}

// ✅ FIXED #5: Add item to THIS budget
function addItem() {
  const item = document.getElementById("item-0").value.trim();
  const price = parseFloat(document.getElementById("price-0").value) || 0;
  const qty = parseFloat(document.getElementById("qty-0").value) || 1;
  if (!item) return;
  
  budgets[0].items.push({ item, price, qty });
  document.getElementById("item-0").value = "";
  document.getElementById("price-0").value = "";
  document.getElementById("qty-0").value = "";
  render();
  saveData(true); // Auto-save
}

// ✅ FIXED #6: Update item
function updateItem(index, field, value) {
  const budget = budgets[0];
  if (field === "item") {
    budget.items[index][field] = value;
  } else {
    budget.items[index][field] = parseFloat(value) || 0;
  }
  render();
  saveData(true); // Auto-save
}

// ✅ FIXED #7: Remove item
function removeItem(index) {
  budgets[0].items.splice(index, 1);
  render();
  saveData(true); // Auto-save
}

// ✅ FIXED #8: Render THIS budget (single mode)
function render() {
  const container = document.getElementById("budgetContainer");
  container.innerHTML = "";
  
  budgets.forEach((budget, bi) => {
    let total = 0;
    
    const card = document.createElement("div");
    card.className = "budget-card";
    card.style.background = budget.color;
    
    const itemsHtml = budget.items.map((item, i) => {
      const itemTotal = item.price * item.qty;
      total += itemTotal;
      return `
        <tr>
          <td contenteditable="true" oninput="updateItem(${i}, 'item', this.innerText)">${item.item}</td>
          <td contenteditable="true" oninput="updateItem(${i}, 'price', this.innerText)">₹${item.price}</td>
          <td contenteditable="true" oninput="updateItem(${i}, 'qty', this.innerText)">${item.qty}</td>
          <td>₹${itemTotal}</td>
          <td class="remove-row" onclick="removeItem(${i})">✖</td>
        </tr>`;
    }).join("");
    
    card.innerHTML = `
      <span class="delete-budget" onclick="deleteBudget()">✖</span>
      <input class="budget-title" value="${budget.title}" 
             onchange="budgets[0].title=this.value; render(); saveData(true);">
      
      <div class="row">
        <input class="item" id="item-0" placeholder="Item">
        <input class="price" id="price-0" placeholder="Price">
        <input class="qty" id="qty-0" placeholder="Qty">
        <button class="add-row-btn" onclick="addItem()">Add</button>
      </div>
      
      <table>
        <thead>
          <tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th><th></th></tr>
        </thead>
        <tbody>${itemsHtml}</tbody>
      </table>
      
      <div class="total">Grand Total: ₹${total}</div>
    `;
    container.appendChild(card);
  });
}

// ✅ FIXED #9: Ctrl+S → Save + Home (EXACTLY like note/todo)
document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.key === "s") {
    e.preventDefault();
    saveData(false);
    setTimeout(() => { window.location.href = "index.html"; }, 1200);
  }
});
</script>
</body>
</html>
