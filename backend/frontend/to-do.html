<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>To-Do List</title>

<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:Segoe UI, sans-serif;
}

body{
  background:#f5f5f5;
  min-height:100vh;
  padding:20px;
}

/* PAGE CONTAINER */
.todo-page{
  max-width:700px;
  margin:auto;
  background:#ffffff;
  padding:25px;
  border-radius:14px;
  box-shadow:0 8px 25px rgba(0,0,0,.15);
}

/* Back Button Style */
.back-link {
  text-decoration: none;
  color: #666;
  font-weight: 600;
  margin-bottom: 20px;
  display: inline-block;
  font-size: 14px;
}
.back-link:hover { color: #000; }

/* TITLE */
.todo-title{
  border:none;
  border-bottom:1px solid #ccc;
  width:100%;
  font-size:22px;
  outline:none;
  padding-bottom:8px;
  margin-bottom:20px;
}

/* INPUT ROW */
.todo-row{
  display:flex;
  align-items:center;
  background:#ececec;
  border-radius:30px;
  padding-left:15px;
  margin-bottom:20px;
}

#input-box{
  flex:1;
  border:none;
  outline:none;
  background:transparent;
  padding:12px;
  font-size:16px;
}

#addTaskBtn{
  border:none;
  outline:none;
  padding:12px 28px;
  background:#000;
  color:#fff;
  font-size:16px;
  cursor:pointer;
  border-radius:30px;
}

#addTaskBtn:hover{
  background:#333;
}

/* LIST */
#list-container{
  margin-top:10px;
}

#list-container li{
  list-style:none;
  font-size:15px;
  padding:12px 10px 12px 40px;
  user-select:none;
  cursor:pointer;
  position:relative;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #f0f0f0;
}

/* CHECKBOX */
#list-container li::before{
  content:'';
  position:absolute;
  height:18px;
  width:18px;
  border-radius:50%;
  border:2px solid #555;
  top:14px;
  left:8px;
  background:white;
}

#list-container li.checked{
  color:#555;
  text-decoration:line-through;
}

#list-container li.checked::before{
  border-color:#000;
  background:#000;
  background-image:url('https://cdn-icons-png.flaticon.com/128/1828/1828640.png');
  background-size:14px;
  background-position:center;
  background-repeat:no-repeat;
}

/* ACTION ICONS */
.actions{
  display:flex;
  gap:14px;
  align-items:center;
}

.bell-icon{
  font-size:16px;
  color:#555;
  cursor:pointer;
}

.bell-icon:hover{
  color:#ff5945;
}

.delete-icon{
  font-size:16px;
  color:#555;
  cursor:pointer;
}

.delete-icon:hover{
  color:red;
}

/* REMINDER MODAL */
#reminderModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  z-index:2000;
}

#reminderModalContent{
  background:#fff;
  padding:30px;
  width:420px;
  margin:120px auto;
  border-radius:10px;
  position:relative;
}

#closeReminder{
  position:absolute;
  right:12px;
  top:8px;
  font-size:18px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="todo-page">
  <!-- Back Button -->
  <a href="index.html" class="back-link">← Back to Home</a>

  <input class="todo-title" id="todoTitle" placeholder="To-Do List Title">

  <div class="todo-row">
    <input id="input-box" placeholder="Add your task">
    <button id="addTaskBtn">Add</button>
  </div>

  <ul id="list-container"></ul>
</div>

<!-- REMINDER MODAL -->
<div id="reminderModal">
  <div id="reminderModalContent">
    <span id="closeReminder">×</span>
    <h3>Set Reminder</h3>
    <input type="datetime-local" id="reminderTime" style="width:100%;padding:8px;margin-top:10px">
    <button onclick="saveTaskReminder()" style="margin-top:15px;padding:8px 15px">Save</button>
  </div>
</div>

<script>
    const API = "https://notes-app-a631.onrender.com";
    const inputBox = document.getElementById("input-box");
    const listContainer = document.getElementById("list-container");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const todoTitle = document.getElementById("todoTitle");
    const reminderModal = document.getElementById("reminderModal");
    let reminderTaskText = null;
    let todoId = null;
    let isSaving = false;

    // ✅ FIXED #1: Get ID from URL (EXACTLY like note.html)
    const params = new URLSearchParams(window.location.search);
    todoId = params.get("id");

    // ✅ FIXED #2: Load existing data + RE-ATTACH events
    if (todoId) {
      fetch(`${API}/todo/${todoId}`)
        .then(res => {
          if(!res.ok) throw new Error("Todo not found");
          return res.json();
        })
        .then(data => {
          todoTitle.value = data.title || "";
          if (data.tasks) {
            listContainer.innerHTML = data.tasks;
            attachTaskEvents(); // ✅ CRITICAL: Re-attach events to loaded tasks
          }
        })
        .catch(err => console.error(err));
    }

    // ✅ FIXED #3: Attach events to ALL tasks (new + loaded)
    function attachTaskEvents() {
      // Check/uncheck on li click (not icons)
      listContainer.querySelectorAll('li').forEach(li => {
        li.onclick = (e) => {
          if (e.target.classList.contains('bell-icon') || e.target.classList.contains('delete-icon')) return;
          li.classList.toggle('checked');
        };
      });

      // Delete icons
      listContainer.querySelectorAll('.delete-icon').forEach(icon => {
        icon.onclick = (e) => {
          e.stopPropagation();
          icon.closest('li').remove();
        };
      });

      // Bell icons
      listContainer.querySelectorAll('.bell-icon').forEach(icon => {
        icon.onclick = (e) => {
          e.stopPropagation();
          reminderTaskText = icon.closest('li').querySelector('span').innerText;
          reminderModal.style.display = "block";
        };
      });
    }

    /* ADD TASK (Local only - NO auto-save) */
    addTaskBtn.onclick = () => {
      if(inputBox.value.trim()==="") return;

      const li = document.createElement("li");
      li.draggable=true;

      const text = document.createElement("span");
      text.innerText=inputBox.value;
      li.appendChild(text);

      const actions=document.createElement("div");
      actions.className="actions";

      const bell=document.createElement("i");
      bell.className="fa-regular fa-bell bell-icon";
      bell.onclick=e=>{
        e.stopPropagation();
        reminderTaskText=text.innerText;
        reminderModal.style.display="block";
      };

      const del=document.createElement("i");
      del.className="fa-solid fa-xmark delete-icon";
      del.onclick=e=>{
        e.stopPropagation();
        li.remove();
      };

      actions.appendChild(bell);
      actions.appendChild(del);
      li.appendChild(actions);

      li.onclick=(e)=>{
        if (e.target.classList.contains('bell-icon') || e.target.classList.contains('delete-icon')) return;
        li.classList.toggle("checked");
      };

      listContainer.appendChild(li);
      inputBox.value="";
      attachTaskEvents(); // ✅ Re-attach for new task
    };

    /* REMINDER (Local only) */
    function saveTaskReminder(){
      const time=document.getElementById("reminderTime").value;
      if(!time) return;

      const delay=new Date(time)-new Date();
      if(delay>0){
        setTimeout(()=>{
          new Notification("To-Do Reminder",{body:reminderTaskText});
        },delay);
      }
      reminderModal.style.display="none";
    }

    document.getElementById("closeReminder").onclick=()=>{
      reminderModal.style.display="none";
    };

    /* 2. SAVE FUNCTION (EXACTLY like note.html) */
    function saveData(silent = false, goHome = false) {
      if (isSaving) return;
      
      const title = todoTitle.value.trim();
      const tasks = listContainer.innerHTML;

      if (!title && !tasks) return;

      isSaving = true;
      
      fetch(`${API}/todo`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: todoId ? parseInt(todoId) : null,
          title,
          tasks
        })
      })
      .then(res => res.json())
      .then(data => {
  if (data.ok) {
    if (data.id && !todoId) {
      todoId = data.id;
      history.replaceState(null, "", `to-do.html?id=${todoId}`);
    }
    if (!silent) alert("Todo Saved ✔");

    if (goHome) {
      window.location.href = "index.html";
    }
  }
})

      .catch(err => console.error("Save error:", err))
      .finally(() => {
        isSaving = false;
      });
    }

    /* 3. CTRL+S (Save → IMMEDIATE Home Redirect) */
    document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.key === "s") {
    e.preventDefault();
    saveData(false, true);
  }
});


    /* NOTIFICATION PERMISSION */
    if("Notification" in window && Notification.permission!=="granted"){
      Notification.requestPermission();
    }

    // ✅ FIXED #4: Initial event attachment
    attachTaskEvents();
</script>

</body>
</html>
