<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Note Editor</title>

<style>
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:Segoe UI, sans-serif;
}

body{
  background:#f3f3f3;
  min-height:100vh;
  display:flex;
  justify-content:center;
  padding:20px;
}

/* ===== SHEET ===== */
.sheet{
  background:#fff;
  width:100%;
  max-width:900px;
  min-height:90vh;
  padding:40px;
  box-shadow:0 10px 30px rgba(0,0,0,0.15);
  position:relative;
  display:flex;
  flex-direction:column;
  border-radius: 8px;
}

/* Back Button Style */
.back-link {
  text-decoration: none;
  color: #666;
  font-weight: 600;
  margin-bottom: 20px;
  display: inline-block;
  font-size: 14px;
}
.back-link:hover { color: #000; }

/* ===== TITLE ===== */
.topic input{
  width:100%;
  border:none;
  border-bottom:1px solid #aaa;
  font-size:22px;
  padding-bottom:6px;
  outline:none;
}

/* ===== CONTENT ===== */
.content{
  display:flex;
  flex:1;
  margin-top:20px;
  gap:20px;
}

.keywords{
  width:30%;
  border-right:1px solid #ddd;
  padding-right:15px;
}

.notes{
  flex:1;
}

.label{
  font-weight:600;
  margin-bottom:6px;
  color: #555;
}

textarea{
  border:none;
  resize:none;
  outline:none;
  font-size:16px;
  line-height:1.6;
  width:100%;
  height:100%;
}

/* ===== MENU (FIXED) ===== */
.note-menu{
  position:absolute;
  bottom:25px;
  right:25px;
  z-index:100;
  width: 60px;
  height: 350px; 
  pointer-events: none; 
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: flex-end;
}

.menu-main{
  width:56px;
  height:56px;
  border-radius:50%;
  background:#000;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
  transition:.3s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  pointer-events: auto; 
  position: absolute;
  bottom: 0;
  right: 0;
  z-index: 10;
}

.note-menu.active .menu-main{
  transform:rotate(45deg);
  background: #333;
}

.menu-item{
  position:absolute;
  right:6px;
  bottom: 0; 
  width:44px;
  height:44px;
  border-radius:50%;
  background:#fff;
  box-shadow:0 6px 15px rgba(0,0,0,0.15);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  transform:scale(.5);
  transition:.3s cubic-bezier(.25,1.2,.4,1);
  cursor:pointer;
  pointer-events: auto; 
  z-index: 5;
}

.menu-item:hover{ background: #f0f0f0; }

.note-menu.active .menu-item{ opacity:1; transform:scale(1); }

.note-menu.active .font{ bottom:70px }
.note-menu.active .size{ bottom:120px }
.note-menu.active .color{ bottom:170px }
.note-menu.active .reminder{ bottom:220px }
.note-menu.active .share{ bottom:270px }

/* ===== OVERLAY ===== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:200;
  backdrop-filter: blur(2px);
}

.popup{
  background:#fff;
  padding:25px;
  border-radius:12px;
  width:340px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
  animation:pop .25s ease;
}

@keyframes pop{
  from{transform:scale(.9);opacity:0}
  to{transform:scale(1);opacity:1}
}

.popup h3{margin-bottom:15px}

.reminder-list {
  max-height: 200px;
  overflow-y: auto;
  margin: 10px 0;
}

.reminder-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}

.reminder-item:last-child { border-bottom: none; }

.delete-reminder {
  background: #ff4444;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 12px;
}

/* MOBILE */
@media(max-width:600px){
  .sheet{padding:20px}
  .content{flex-direction: column;}
  .keywords{width:100%; border-right:none; border-bottom:1px solid #ddd; padding-bottom: 20px;}
}
</style>
</head>

<body>
<div class="sheet">
  <a href="index.html" class="back-link">‚Üê Back to Home</a>

  <div class="topic">
    <input id="noteTitle" placeholder="Topic">
  </div>

  <div class="content">
    <div class="keywords">
      <div class="label">Important Keywords</div>
      <textarea id="keywords" placeholder="Press Enter for bullets..."></textarea>
    </div>

    <div class="notes">
      <div class="label">Notes</div>
      <textarea id="notes" placeholder="Start typing..." style="font-family: inherit; font-size: inherit; color: inherit;"></textarea>
    </div>
  </div>

  <!-- MENU -->
  <div class="note-menu" id="menu">
    <div class="menu-item font" title="Font">A</div>
    <div class="menu-item size" title="Size">Aa</div>
    <div class="menu-item color" title="Color">üé®</div>
    <div class="menu-item reminder" title="Reminder">‚è∞</div>
    <div class="menu-item share" title="Share">üîó</div>
    <div class="menu-main" id="menuBtn">‚úèÔ∏è</div>
  </div>
</div>

<!-- POPUPS -->
<div class="overlay" id="fontPopup"><div class="popup"><h3>Font</h3>
<select id="fontSelect" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
<option value="Segoe UI,sans-serif">Segoe UI</option>
<option value="Calibri,sans-serif">Calibri</option>
<option value="Arial,sans-serif">Arial</option>
<option value="'Times New Roman',serif">Times New Roman</option>
<option value="Georgia,serif">Georgia</option>
<option value="'Courier New',monospace">Courier New</option>
</select></div></div>

<div class="overlay" id="sizePopup"><div class="popup"><h3>Size</h3>
<select id="sizeSelect" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
<option value="16px" selected>16px</option><option value="18px">18px</option><option value="20px">20px</option>
</select></div></div>

<div class="overlay" id="colorPopup"><div class="popup"><h3>Color</h3>
<input type="color" id="colorPicker" style="width:100%;height:40px;cursor:pointer;">
</div></div>

<!-- REMINDER WITH LABEL INPUT -->
<div class="overlay" id="reminderPopup"><div class="popup">
<h3>Reminders</h3>
<input type="text" id="reminderLabel" placeholder="Reminder label (e.g. Meeting, Deadline)" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin-bottom:10px;">
<input type="datetime-local" id="reminderTime" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;margin-bottom:10px;">
<button onclick="saveReminder()" style="width:100%;padding:10px;background:#000;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-bottom:15px;">Add Reminder</button>
<div class="reminder-list" id="reminderList">
  <div style="text-align:center;color:#888;font-size:12px;padding:10px;">No reminders set</div>
</div>
</div></div>

<div class="overlay" id="qrPopup"><div class="popup">
<h3>Share</h3><p style="text-align:center;padding:20px;background:#eee;border-radius:4px;">[QR Code Generator]</p>
</div></div>

<script>
/* ================= CONFIG ================= */
const API = "https://notes-app-5-sgzz.onrender.com"; // Your API URL
const params = new URLSearchParams(window.location.search);
let noteId = params.get("id");
let isSaving = false;

// PASTE YOUR GENERATED PUBLIC KEY HERE
const PUBLIC_VAPID_KEY = "BCjE7S3Qg5wOKbwx1Sirc5ElWzhKFjNMfEWUQskfdwNoyQg026mlf6e6-1TvAod_cwaN1oh-Unr6klWxruhi-IY"; 

/* ================= SERVICE WORKER & PUSH ================= */
// 1. Convert Key Helper
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

// 2. Register & Subscribe
async function setupPushNotifications() {
  if (!('serviceWorker' in navigator)) return;

  const register = await navigator.serviceWorker.register('sw.js');
  await navigator.serviceWorker.ready;

  // Check if already subscribed
  let subscription = await register.pushManager.getSubscription();

  // If not, subscribe
  if (!subscription) {
    subscription = await register.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY)
    });
  }

  // Send subscription to Backend
  await fetch(`${API}/subscribe`, {
    method: 'POST',
    body: JSON.stringify(subscription),
    headers: { 'content-type': 'application/json' }
  });
}

// Trigger setup on load
setupPushNotifications().catch(err => console.error("Push setup failed", err));

/* ================= ELEMENTS ================= */
const titleInput = document.getElementById("noteTitle");
const keywordsInput = document.getElementById("keywords");
const notesInput = document.getElementById("notes");
const reminderLabel = document.getElementById("reminderLabel");
const reminderTime = document.getElementById("reminderTime");
const reminderList = document.getElementById("reminderList");
const menu = document.getElementById("menu");
const menuBtn = document.getElementById("menuBtn");
const overlays = document.querySelectorAll(".overlay");

/* ================= LOAD DATA ================= */
if (noteId) {
  fetch(`${API}/note/${noteId}`)
    .then(r => r.json())
    .then(d => {
      titleInput.value = d.title || "";
      keywordsInput.value = d.keywords || "";
      notesInput.value = d.content || "";
      loadReminders(); // Load from DB
    });
} else {
  // New note, no reminders yet
}

/* ================= REMINDER LOGIC (SERVER-SIDE) ================= */

function loadReminders() {
  if (!noteId) return;
  fetch(`${API}/reminders/${noteId}`)
    .then(r => r.json())
    .then(data => renderReminders(data));
}

function renderReminders(reminders) {
  if (!reminders.length) {
    reminderList.innerHTML = `<div style="text-align:center;color:#888;font-size:12px;padding:10px;">No reminders set</div>`;
    return;
  }
  reminderList.innerHTML = reminders.map(r => `
    <div class="reminder-item">
      <div>
        <strong>${r.label}</strong><br>
        <small>${new Date(r.time).toLocaleString()}</small>
      </div>
      <button class="delete-reminder" onclick="deleteReminder(${r.id})">Delete</button>
    </div>
  `).join("");
}

function saveReminder() {
  const label = reminderLabel.value.trim();
  const time = reminderTime.value;

  if (!label || !time) return alert("Label & time required");
  if (!noteId) return alert("Save note first (Ctrl+S)");

  // Send to Backend
  fetch(`${API}/reminders`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ noteId, label, time })
  })
  .then(() => {
    alert("Reminder Set! It will notify you even if closed.");
    reminderLabel.value = "";
    reminderTime.value = "";
    loadReminders(); // Refresh list
    closePopups();
  });
}

function deleteReminder(id) {
  fetch(`${API}/reminders/${id}`, { method: "DELETE" })
    .then(() => loadReminders());
}

/* ================= SAVE NOTE ================= */
// (Keep your existing saveNote logic here exactly as it was)
function saveNote(silent = false) {
  if (isSaving) return;
  const title = titleInput.value.trim();
  const keywords = keywordsInput.value.trim();
  const content = notesInput.value.trim();
  if (!title && !content && !keywords) return;

  isSaving = true;

  fetch(`${API}/note`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id: noteId ? Number(noteId) : null,
      title,
      keywords,
      content
    })
  })
  .then(r => r.json())
  .then(d => {
    if (d.id) {
      noteId = d.id;
      history.replaceState(null, "", `note.html?id=${noteId}`);
    }
    if (!silent) alert("Note Saved ‚úî");
    loadReminders(); // Refresh reminders in case note ID changed
  })
  .finally(() => isSaving = false);
}

/* ================= UI LOGIC ================= */
// (Keep your existing Menu/Popup logic exactly as it was)
menuBtn.onclick = e => { e.stopPropagation(); menu.classList.toggle("active"); };
window.onclick = e => { if (!menu.contains(e.target)) menu.classList.remove("active"); };

function openPopup(id) {
  menu.classList.remove("active");
  closePopups();
  document.getElementById(id).style.display = "flex";
  if (id === "reminderPopup") loadReminders();
}

function closePopups() {
  overlays.forEach(o => o.style.display = "none");
}
overlays.forEach(o => o.onclick = e => { if (e.target === o) closePopups(); });

/* ================= SHORTCUT ================= */
setInterval(() => saveNote(true), 30000);
document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.key === "s") {
    e.preventDefault();
    saveNote(false);
  }
});

/* ================= MENU HANDLERS ================= */
["font","size","color","reminder","share"].forEach(type => {
  const item = document.querySelector(`.menu-item.${type}`);
  if (!item) return;
  item.onclick = e => {
    e.stopPropagation();
    openPopup(
      type === "font" ? "fontPopup" :
      type === "size" ? "sizePopup" :
      type === "color" ? "colorPopup" :
      type === "reminder" ? "reminderPopup" :
      "qrPopup"
    );
  };
});
// Helper to convert VAPID key to Uint8Array
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

const VAPID_PUBLIC_KEY = "BCjE7S3Qg5wOKbwx1Sirc5ElWzhKFjNMfEWUQskfdwNoyQg026mlf6e6-1TvAod_cwaN1oh-Unr6klWxruhi-IY";

async function subscribeUser() {
  if ('serviceWorker' in navigator) {
    const registration = await navigator.serviceWorker.ready;
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
    });

    await fetch('/subscribe', {
      method: 'POST',
      body: JSON.stringify(subscription),
      headers: { 'Content-Type': 'application/json' }
    });
    console.log("Subscribed successfully");
  }
}
// Call this when the note page loads
subscribeUser();
</script>


</body>
</html>
