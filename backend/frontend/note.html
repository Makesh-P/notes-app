<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Note Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Segoe UI,sans-serif;background:#f3f3f3;padding:20px}
.sheet{background:#fff;max-width:900px;margin:auto;padding:30px;border-radius:8px;box-shadow:0 10px 25px rgba(0,0,0,.15)}
.back-link{text-decoration:none;color:#666;font-weight:600}
input,textarea{width:100%;border:none;outline:none;font-size:16px}
textarea{resize:none;height:200px}
.menu{position:fixed;bottom:30px;right:30px}
.menu button{width:55px;height:55px;border-radius:50%;border:none;background:#000;color:#fff;font-size:22px;cursor:pointer}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
.box{background:#fff;padding:20px;border-radius:10px;width:320px}
.reminder-item{display:flex;justify-content:space-between;font-size:14px;padding:6px 0}
</style>
</head>

<body>

<div class="sheet">
  <a href="index.html" class="back-link">← Back</a><br><br>

  <input id="title" placeholder="Note title"><br><br>
  <textarea id="content" placeholder="Write your note..."></textarea>
</div>

<div class="menu">
  <button onclick="openReminder()">⏰</button>
</div>

<div class="popup" id="reminderPopup">
  <div class="box">
    <h3>Add Reminder</h3>
    <input id="remLabel" placeholder="Label (Exam, Meeting)">
    <input id="remTime" type="datetime-local"><br><br>
    <button onclick="saveReminder()">Save</button>
    <hr>
    <div id="remList"></div>
  </div>
</div>

<script>
const API = "https://notes-app-5-sgzz.onrender.com";
const params = new URLSearchParams(location.search);
let noteId = params.get("id");
let timerRefs = [];

const titleInput = document.getElementById("title");
const contentInput = document.getElementById("content");

/* ----------- LOAD NOTE ----------- */
if(noteId){
 fetch(`${API}/note/${noteId}`)
  .then(r=>r.json())
  .then(d=>{
    titleInput.value=d.title||"";
    contentInput.value=d.content||"";
  });
}

/* ----------- SAVE NOTE ----------- */
function saveNote(){
 fetch(`${API}/note`,{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({
    id: noteId?Number(noteId):null,
    title:titleInput.value,
    keywords:"",
    content:contentInput.value
  })
 })
 .then(r=>r.json())
 .then(d=>{
   if(!noteId){
     noteId=d.id;
     history.replaceState(null,"",`note.html?id=${noteId}`);
   }
 });
}

document.addEventListener("keydown",e=>{
 if(e.ctrlKey && e.key==="s"){
  e.preventDefault();
  saveNote();
  setTimeout(()=>location.href="index.html",1200);
 }
});

/* ----------- REMINDERS ----------- */
function getReminders(){
 return JSON.parse(localStorage.getItem("noteReminders")||"[]");
}
function setReminders(r){
 localStorage.setItem("noteReminders",JSON.stringify(r));
}

function openReminder(){
 if(!noteId){ alert("Save note first"); return; }
 document.getElementById("reminderPopup").style.display="flex";
 renderReminders();
}

function saveReminder(){
 const label=document.getElementById("remLabel").value;
 const time=document.getElementById("remTime").value;
 if(!label||!time) return alert("Fill all fields");

 const all=getReminders();
 all.push({
  id:Date.now(),
  noteId,
  label,
  time,
  fired:false
 });
 setReminders(all);
 document.getElementById("remLabel").value="";
 document.getElementById("remTime").value="";
 renderReminders();
 scheduleReminders();
}

function renderReminders(){
 const list=document.getElementById("remList");
 const r=getReminders().filter(x=>x.noteId==noteId);
 if(!r.length){list.innerHTML="<small>No reminders</small>";return;}
 list.innerHTML=r.map(x=>`
  <div class="reminder-item">
   <span>${x.label}</span>
   <button onclick="delReminder(${x.id})">✖</button>
  </div>`).join("");
}

function delReminder(id){
 setReminders(getReminders().filter(r=>r.id!==id));
 renderReminders();
}

function scheduleReminders(){
 timerRefs.forEach(clearTimeout);
 timerRefs=[];
 getReminders().forEach(r=>{
  if(r.fired) return;
  const delay=new Date(r.time)-Date.now();
  if(delay>0){
   timerRefs.push(setTimeout(()=>{
    new Notification("Note Reminder",{body:r.label});
    r.fired=true;
    setReminders(getReminders().map(x=>x.id===r.id?r:x));
   },delay));
  }
 });
}

if("Notification"in window && Notification.permission!=="granted"){
 Notification.requestPermission();
}

scheduleReminders();
</script>
</body>
</html>
